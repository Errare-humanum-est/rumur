task:

  # increase timeout to the maximum limit
  timeout_in: 120m

  matrix:
    - name: FreeBSD 13.0
      freebsd_instance:
        image_family: freebsd-13-0-snap
      install_script: pkg upgrade -y && pkg install -y bash bison cmake gmp libxml2 z3
    - name: FreeBSD 12.1
      freebsd_instance:
        image_family: freebsd-12-1-snap
      install_script: pkg upgrade -y && pkg install -y bash bison cmake gmp libxml2 z3
    - name: FreeBSD 11.3
      freebsd_instance:
        image_family: freebsd-11-3-snap
      install_script: pkg upgrade -y && pkg install -y bash bison cmake gmp libxml2 z3

    - name: macOS, XCode 11.3.1, Homebrew
      osx_instance:
        image: catalina-xcode-11.3.1
      environment:
        PATH: /usr/local/opt/bison/bin:${PATH}
        CXXFLAGS: -fsanitize=address -Werror
      install_script: brew update && brew install bison && brew link bison --force
    - name: macOS, XCode 11.4.1, Homebrew
      osx_instance:
        image: catalina-xcode-11.4.1
      environment:
        PATH: /usr/local/opt/bison/bin:${PATH}
        CXXFLAGS: -fsanitize=address -Werror
      install_script: brew update && brew install bison && brew link bison --force
    - name: macOS, XCode 11.5, Homebrew
      osx_instance:
        image: catalina-xcode-11.5
      environment:
        PATH: /usr/local/opt/bison/bin:${PATH}
        CXXFLAGS: -fsanitize=address -Werror
      install_script: brew update && brew install bison && brew link bison --force
    - name: macOS, XCode 11.6, Homebrew
      osx_instance:
        image: catalina-xcode-11.6
      environment:
        PATH: /usr/local/opt/bison/bin:${PATH}
        CXXFLAGS: -fsanitize=address -Werror
      install_script: brew update && brew install bison && brew link bison --force
    - name: macOS, XCode 12.0, Homebrew
      osx_instance:
        image: catalina-xcode-12.0
      environment:
        PATH: /usr/local/opt/bison/bin:${PATH}
        CXXFLAGS: -fsanitize=address -Werror
      install_script: brew update && brew install bison && brew link bison --force
    - name: macOS, XCode 12.1, Homebrew
      osx_instance:
        image: catalina-xcode-12.1
      environment:
        PATH: /usr/local/opt/bison/bin:${PATH}
        CXXFLAGS: -fsanitize=address -Werror
      install_script: brew update && brew install bison && brew link bison --force

  # we limit the test suite to a single thread because the Cirrus CI VMs claim
  # to have 2 CPUs but do not seem to give two concurrent processes enough CPU
  # time and we end up having some of the SMT tests time out
  test_script: uname -sr && python3 --version && mkdir build && cd build && cmake .. && cmake --build . && sudo cmake --build . -- install && ../tests/run-tests.py --jobs 1
